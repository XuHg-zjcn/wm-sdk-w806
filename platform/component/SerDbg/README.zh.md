# W806串口调试工具
通过串口用GDB调试W806，省去CKLINK  
版本v0.1 : 首次发布可用版本  

## 使用方法
```bash
make flash
./tools/gdbserver/main.py ttyUSB0

#在另一个窗口中打开
csky-abiv2-elf-gdb bin/build/W806/image/W806.elf -ex "target remote 127.0.0.1:3334"
```


## 运行原理
### 断点功能:
1. 通过串口收到设置断点的命令
2. 保存断点处2字节原来的内容
3. 把断点处烧录成0x0000（Flash只能把1写成0，XT804指令集里断点指令刚好是0x0000）
4. 运行到断点，CPU触发断点异常(编号：8)，进入相应的中断服务程序
5. 保存寄存器，与上位机进行通信
6. 把断点处的指令搬到RAM中（如果是32字节指令，还需从Flash中复制后半字）
7. 把CPU设置成指令追踪模式，下面有介绍
8. 跳转到RAM中，执行断点处的指令
9. 进入追踪中断，跳转到下一条指令位置（如果这条指令读取PC，需要软件模拟）
10. 继续执行程序
11. 退出前擦除Flash，把原来的内容写回去，否则无法通过开机校验。

### 单布执行功能：
单步执行每执行一条指令，就与上位机进行通信。主要使用了CPU的指令追踪功能  
1. 通过串口收到单步执行命令
2. EPSR的TM位段[14:15]设置为01
3. 退出串口中断，把EPSR存入PSR，继续运行
4. 运行一条指令后，进入追踪中断
5. 与上位机进行通信
6. 如需退出单步执行，将EPSR[14:15]设置为00
9. 退出追踪中断


## 使用说明
目前项目还没有正式完成，只能简单使用，可能存在很多问题，使用起来还不方便。  
后续会提供其他平台的免调试器的单片机GDB调试工具，不止限于串口，也可能通过USB,WiFi等方式通信。  


## GPL合规指南
### 以下内容仅供参考：  
本程序使用GPLv3或更新授权，如果您将本程序与其他代码，合并一个较大的程序，会构成本程序的修改版本，传送较大的程序时需要提供相应的代码。  
目前单片机上程序隔离的机制不够完善，我不确定RTOS上两个任务是否为两个独立的程序，使用可能会有一定风险。  
我认为本程序主要会用于开发中，在最终产品上不太可能会用到，主要由于这个原因，我选择采用了GPLv3这种严格的Copyleft许可证授权本程序，
以保证本程序的修改版本仍然是自由软件，对用户正常使用的影响较小，只要在发布的产品中移除，仍然可用于开发专有软件。  

### 在这里提供移除本程序的方法：  
为了确保彻底删除本程序，建议在发布您的程序或产品前，先复制工程到另一个文件夹，再删除本程序的代码，重新编译一遍。  
```bash
cd ..
mkdir other_dir
cp -r wm-sdk-w806/* wm-sdk-w806_nogpl
cd wm-sdk-w806_nogpl/
make clean
rm -r platform/component/SerDbg
rm -r tools/gdbserver
make all
```
如果有编译错误请手动修复，移除所有调用本程序的代码。  
配套的上位机程序`tools/gdbserver/`文件夹下的所有文件也采用GPLv3或更新授权  

--------------------

## 参考资料
[玄铁E804用户手册](https://www.t-head.cn/technology?icon=E804)
